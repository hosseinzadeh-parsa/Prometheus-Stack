# Prometheus Monitoring Stack

![Prometheus Stack](image/Prometheus-Architecture.gif "Prometheus-Stack")

Hereâ€™s a quick start guide using a Docker Compose file to launch a [Prometheus](`http://prometheus.io/`) monitoring stack. This setup includes Prometheus, Grafana, and the Node Exporter, giving you a complete solution to monitor your Docker infrastructure.

---

## ğŸ¬ Containers Defination

- **Prometheus** â€“ Central metrics database and monitoring engine.
- **Prometheus Pushgateway** â€“ Accepts metrics pushed from short-lived or batch jobs.
- **Alertmanager** â€“ Handles and manages alerts generated by Prometheus.
- **Grafana** â€“ Provides dashboards and visualizations for collected metrics.
- **Node Exporter** â€“ Collects host-level hardware and OS metrics.
- **cAdvisor** â€“ Monitors and exposes container-level performance metrics.
- **Blackbox Exporter** â€“ Probes endpoints (HTTP, HTTPS, DNS, TCP, ICMP, gRPC) for availability and response monitoring.

---

## ğŸ“ Project Structure

```bash
prometheus-stack
â”œâ”€â”€ alertmanager
â”‚Â Â  â””â”€â”€ alertmanager.yml
â”œâ”€â”€ blackbox
â”‚Â Â  â””â”€â”€ blackbox-exporter.yml
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ grafana
â”‚Â Â  â”œâ”€â”€ dashboards
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BlackboxPingTest.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dashboard.yml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DockerContainerMonitor.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ GrafanaMetrics.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ NodeExporterFull.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Prometheus2.0Stats.json
â”‚Â Â  â”‚Â Â  â””â”€â”€ Traefik2Dashboard.json
â”‚Â Â  â””â”€â”€ datasources
â”‚Â Â      â””â”€â”€ datasource.yml
â”œâ”€â”€ image
â”‚Â Â  â””â”€â”€ Prometheus-Architecture.gif
â”œâ”€â”€ prometheus
â”‚Â Â  â”œâ”€â”€ alerts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Alertmanager.rules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ BlackBox.rules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Cadvisor.rules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Node_Exporter.rules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Prometheus.rules
â”‚Â Â  â”‚Â Â  â””â”€â”€ Traefik.rules
â”‚Â Â  â””â”€â”€ prometheus.yml
â”‚â”€â”€ Prometheus-Service-Discovery.md
â”‚â”€â”€ README.md
â””â”€â”€ traefik-core
    â””â”€â”€ docker-compose.yml
```

---

## âš™ï¸ How to configure Prometheus Stack?

### Change environment variables:

```bash
# Services image tag
PROMETHEUS_IMAGE_TAG=v3.5.0
GRAFANA_IMAGE_TAG=11.5
ALERTMANAGER_IMAGE_TAG=v0.28.1
PUSHGATEWAY_IMAGE_TAG=v1.11.1
CADVISOR_IMAGE_TAG=v0.52.0
BLACKBOX_EXPORTER_IMAGE_TAG=v0.27.0
NODE_EXPORTER_IMAGE_TAG=v1.9.1

# Domain address
DOMAIN_ADDRESS=observability.byparsa.dev
PROSUB=metrics
GRASUB=grafana
ALESUB=alerts
PGWSUB=pushgw

# Grafana Auth
GRAFANA_USERNAME=DevOps
GRAFANA_PASSWORD=<GRAFANA_ADMIN_PASSWORD>
GRAFANA_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel

# Server Name
HOSTNAME=observability

# set restart policy
RESTART_POLICY=on-failure
```

### Setup Grafana:

Open http://<host-ip>:3000 in your browser and log in with the default credentials:

- **Username:** `admin`
- **Password:** `admin`

You can update these credentials either directly in the Compose file or by defining the environment variables `GRAFANA_USERNAME`, `GRAFANA_PASSWORD`, and `GRAFANA_INSTALL_PLUGINS` in a `.env` file before running docker compose up.

Grafana is provisioning dashboards and data sources with these configs:

```bash
apiVersion: 1
datasources:
- name: Prometheus
  type: prometheus
  access: proxy
  url: http://prometheus:9090
  editable: true
  isDefault: true
```

```bash
apiVersion: 1
providers:
- name: 'Prometheus'
  orgId: 1
  folder: 'DevOps_Services'
  type: file
  disableDeletion: false
  editable: true
  options:
    path: /etc/grafana/provisioning/dashboards
```

### Alerting:

Alerting has been added to the stack with Slack integration.

All rules in `prometheus/alerts` directory.

Notification media config for Telegram and Email receivers in  `alertmanager/alertmanager.yml`

### Deploy with docker compose:

```bash
# check compose file syntax
docker compose config

# pull all images in compose file
docker compose pull

# run all containers in compose file
docker compose up -d
```

---

## ğŸš¨ Prometheus Alertmanager â†’ Telegram: How to Configure Alerts

### Step One â†’ Create a Telegram Bot

Use [@botfather](https://core.telegram.org/bots#6-botfather) to create a new bot and obtain its **bot token**.

### Step Two â†’ Create a Telegram Channel

- Create a new channel in Telegram.
- Invite your bot to the channel.
- Assign the bot as an **admin**.

### Step Three â†’ Get the Chat ID

**1.** Send a message in your channel.
**2.** Open the following URL in your browser:
```bash
https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
```
**3.** Look for the `chat.id` field in the JSON response.
> âš ï¸ Note: The ID may start with a `-` sign (negative integer). Copy the entire value.

**4.** If no updates are shown, send another message in the channel and refresh the URL.

**5.** Save the chat ID for later use.

### Step Four â†’ Configure Alertmanager

See the official docs: [Alertmanager Configuration](https://prometheus.io/docs/alerting/latest/configuration).

Example configuration:

```yaml
global:
  resolve_timeout: 1m
  smtp_smarthost: "<YOUR SMTP SERVER ADDRESS>"
  smtp_from: "<YOUR MAILBOX ADDRESS>"
  smtp_auth_username: "<YOUR MAILBOX ADDRESS>"
  smtp_auth_password: "<YOUR MAILBOX PASSWORD>"
  smtp_auth_identity: "<YOUR MAILBOX ADDRESS>"

route:
  receiver: "Production_Environment"
  group_wait: 30s
  group_interval: 30s
  repeat_interval: 30s
  group_by: ["alertname", "severity", "instance"]
  routes:
    - matchers: ['alertname="PrometheusAlertmanagerE2eDeadManSwitch"']
      receiver: "Production_Environment"
      group_wait: 0s
      repeat_interval: 12h

receivers:
  - name: "Production_Environment"
    telegram_configs:
      - bot_token: "<YOUR TELEGRAM BOT TOKEN>"
        api_url: "https://api.telegram.org"
        chat_id: <YOUR TELEGRAM CHAT ID>
        parse_mode: ""
        send_resolved: true
        disable_notifications: false
        http_config:
          proxy_url: "<YOUR HTTP PROXY FOR SENT TELEGRAM MESSAGE>"
          follow_redirects: true
          enable_http2: true
    email_configs:
      - to: "<YOUR RECEIVER MAILBOX>"
        send_resolved: true
```

### Step Five â†’ Test the Configuration

Run the following command to trigger a test alert:

```bash
amtool --alertmanager.url=http://localhost:9093/ alert add alertname="test123" severity="test-telegram" job="test-alert" instance="localhost" exporter="none" cluster="test"
```

### Step Six â†’ Important Notes

- Chat IDs must be specified **without quotes** in the config.
- Make sure `api.telegram.org` is whitelisted if youâ€™re behind a proxy.
- To find user, group, or channel IDs, use this bot: [@username_to_id_bot](https://t.me/username_to_id_bot).
- Reference: [Alertmanager Telegram Config](https://prometheus.io/docs/alerting/latest/configuration/#telegram_config).

---

## ğŸ‘¤ Author

**Parsa Hosseinzadeh**  
Linux Administrator & Security Enthusiast  
GitHub: [hosseinzadeh-parsa](https://github.com/hosseinzadeh-parsa)